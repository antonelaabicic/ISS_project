@page "/logout"
@using ClientApp.Service
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject AuthStateService AuthState
@rendermode InteractiveServer

<h3>Logging out...</h3>

<script>
    window.performLogout = async function () {
        try {
            await fetch("http://localhost:8080/auth/logout", {
                method: "POST",
                credentials: "include" 
            });
        } catch (err) {
            console.error("Logout error:", err);
        } finally {
            sessionStorage.removeItem("accessToken");
            window.location.href = "/login";
        }
    };
</script>

@code {
    private bool _logoutStarted = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_logoutStarted)
        {
            _logoutStarted = true;
            await JS.InvokeVoidAsync("performLogout");
            AuthState.SetLoggedIn(false);
        }
    }
}
